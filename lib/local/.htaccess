# Cluster Site Rewrite Rules
#
# Notice, W3 Total Cache adds an .htaccess to /system which will break /system redirects here.
#
# @version 2.0.1
# @author potanin@UD

# Cross-domain AJAX requests
<IfModule mod_headers.c>
  Header set Access-Control-Allow-Origin "*"
</IfModule>

# MIME TYPES AND ENCODING
<IfModule mod_mime.c>

  # Audio
  AddType audio/mp4                                   m4a f4a f4b
  AddType audio/ogg                                   oga ogg

  # JavaScript
  # Normalize to standard type (it's sniffed in IE anyways):
  # http://tools.ietf.org/html/rfc4329#section-7.2
  AddType application/javascript                      js
  AddType application/json                            json

  # Video
  AddType video/mp4                                   mp4 m4v f4v f4p
  AddType video/ogg                                   ogv
  AddType video/webm                                  webm
  AddType video/x-flv                                 flv

  # Web fonts
  AddType application/font-woff                       woff
  AddType application/vnd.ms-fontobject               eot

  # Browsers usually ignore the font MIME types and sniff the content,
  # however, Chrome shows a warning if other MIME types are used for the
  # following fonts.
  AddType application/x-font-ttf                      ttc ttf
  AddType font/opentype                               otf

  # Make SVGZ fonts work on iPad:
  # https://twitter.com/FontSquirrel/status/14855840545
  AddType     image/svg+xml                           svg svgz
  AddEncoding gzip                                    svgz

  # Other
  AddType application/octet-stream                    safariextz
  AddType application/x-chrome-extension              crx
  AddType application/x-opera-extension               oex
  AddType application/x-shockwave-flash               swf
  AddType application/x-web-app-manifest+json         webapp
  AddType application/x-xpinstall                     xpi
  AddType application/xml                             atom rdf rss xml
  AddType image/webp                                  webp
  AddType image/x-icon                                ico
  AddType text/cache-manifest                         appcache manifest
  AddType text/vtt                                    vtt
  AddType text/x-component                            htc
  AddType text/x-vcard                                vcf

</IfModule>

# UTF-8 encoding
AddDefaultCharset utf-8

# Force UTF-8 for certain file formats.
<IfModule mod_mime.c>
  AddCharset utf-8 .atom .css .js .json .rss .vtt .webapp .xml
</IfModule>

# URL REWRITES
<IfModule mod_rewrite.c>
  Options +FollowSymlinks
  RewriteEngine On
  RewriteBase /
</IfModule>

# Suppressing / Forcing the "www." at the beginning of URLs
<IfModule mod_rewrite.c>
  RewriteCond %{HTTPS} !=on
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^ http://%1%{REQUEST_URI} [R=301,L]
</IfModule>

# Block access to hidden files and directories.
<IfModule mod_rewrite.c>
  RewriteCond %{SCRIPT_FILENAME} -d [OR]
  RewriteCond %{SCRIPT_FILENAME} -f
  RewriteRule "(^|/)\." - [F]
</IfModule>

# Block access to backup and source files.
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
  Order allow,deny
  Deny from all
  Satisfy All
</FilesMatch>

# Expires headers (for better cache control)
<IfModule mod_expires.c>

  ExpiresActive on
  ExpiresDefault                                      "access plus 1 month"

  # CSS
  ExpiresByType text/css                              "access plus 1 year"

  # Data interchange
  ExpiresByType application/json                      "access plus 0 seconds"
  ExpiresByType application/xml                       "access plus 0 seconds"
  ExpiresByType text/xml                              "access plus 0 seconds"

  # Favicon (cannot be renamed!)
  ExpiresByType image/x-icon                          "access plus 1 week"

  # HTML components (HTCs)
  ExpiresByType text/x-component                      "access plus 1 month"

  # HTML
  ExpiresByType text/html                             "access plus 0 seconds"

  # JavaScript
  ExpiresByType application/javascript                "access plus 1 year"

  # Manifest files
  ExpiresByType application/x-web-app-manifest+json   "access plus 0 seconds"
  ExpiresByType text/cache-manifest                   "access plus 0 seconds"

  # Media
  ExpiresByType audio/ogg                             "access plus 1 month"
  ExpiresByType image/gif                             "access plus 1 month"
  ExpiresByType image/jpeg                            "access plus 1 month"
  ExpiresByType image/png                             "access plus 1 month"
  ExpiresByType video/mp4                             "access plus 1 month"
  ExpiresByType video/ogg                             "access plus 1 month"
  ExpiresByType video/webm                            "access plus 1 month"

  # Web feeds
  ExpiresByType application/atom+xml                  "access plus 1 hour"
  ExpiresByType application/rss+xml                   "access plus 1 hour"

  # Web fonts
  ExpiresByType application/font-woff                 "access plus 1 month"
  ExpiresByType application/vnd.ms-fontobject         "access plus 1 month"
  ExpiresByType application/x-font-ttf                "access plus 1 month"
  ExpiresByType font/opentype                         "access plus 1 month"
  ExpiresByType image/svg+xml                         "access plus 1 month"

</IfModule>

# Modules
<IfModule mod_rewrite.c>
  RewriteRule ^system/wp-content/plugins/(.*)$ modules/$1 [R=301,L]
  RewriteRule ^wp-content/plugins/(.*)$ modules/$1 [L]
</IfModule>

# Themes
<IfModule mod_rewrite.c>
  # RewriteRule ^wp-content/themes/nightculture-theme/images(.*)$ themes/rockstar/images/legacy/$1 [L]
  RewriteRule ^wp-content/themes/(.*)$ themes/$1 [L]
</IfModule>

# Management
<IfModule mod_rewrite.c>
  RewriteRule ^manage/network(.*)$ /vendor/wordpress/core/wp-admin/network$1 [L]
  RewriteRule ^manage/login$ /vendor/wordpress/core/wp-login.php [L]
  RewriteRule ^manage/(.*)$ /vendor/wordpress/core/wp-admin/$1 [L]
  RewriteRule ^manage$ /vendor/wordpress/core/wp-admin/$1 [L]
</IfModule>

# Security
<IfModule mod_rewrite.c>
  RewriteRule ^node_modules/(.*)$ /index.php [L]
  RewriteRule ^readme.md$ /index.php [L]
  RewriteRule ^wp-cli.yml$ /index.php [L]
  RewriteRule ^package.json$ /index.php [L]
  RewriteRule ^gruntfile.js$ /index.php [L]
  RewriteRule ^composer.json$ /index.php [L]
  RewriteRule ^composer.lock$ /index.php [L]
  RewriteRule ^wp-config.php$ /index.php [L]

  # W3 Total Cache Configuration Files.
  RewriteRule ^w3tc-config/master.php$ /index.php [L]
  RewriteRule ^w3tc-config/master-admin.php$ /index.php [L]

  # Application Access.
  RewriteRule ^application/$ /index.php [L]
  RewriteRule ^application/(config|defaults|lib)/(.*)$ /index.php [L]

  # Legacy Paths
  #RewriteRule ^wp-login.php$ /index.php [L]
  #RewriteRule ^wp-admin/$ /index.php [L]

</IfModule>

# Media
<IfModule mod_rewrite.c>
  RewriteRule ^uploads/(.*)$ /static/storage/%{SERVER_NAME}/$1 [L]
  RewriteRule ^media/(.*)$ /static/storage/%{SERVER_NAME}/$1 [L]
  #RewriteRule ^wp-content/uploads/(.*)$ media/%{SERVER_NAME}/$1 [L]
  #RewriteRule ^system/files/(.*)$ media/%{SERVER_NAME}/$1 [L]
  #RewriteRule ^media/(.*)$ media/%{SERVER_NAME}/$1 [L]
</IfModule>

# Caching
<IfModule mod_deflate.c>

  <IfModule mod_headers.c>
    Header append Vary User-Agent env=!dont-vary
  </IfModule>

  AddOutputFilterByType DEFLATE text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/html text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon application/json

  # DEFLATE by extension
  <IfModule mod_mime.c>
    AddOutputFilter DEFLATE js css htm html xml
  </IfModule>

</IfModule>

# Standard WordPress
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.php$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.php [L]
</IfModule>